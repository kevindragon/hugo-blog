---
title: "Python Docker FastAPIå¿«é€Ÿå¼€å‘éƒ¨ç½²RESTful API"
date: "2023-06-06T19:32:18+08:00"
tags: ["Python", "FastAPI", "Docker"]
categories: [ç¼–ç¨‹è¯­è¨€]
---

æœ¬æ–‡ä»‹ç»å¦‚ä½•å¿«é€Ÿä½¿ç”¨Python, Docker, FastAPIå¿«é€Ÿå¼€å‘RESTful APIï¼Œä»¥åŠå¦‚ä½•ç¼–è¯‘ä¸ºDockeré•œåƒï¼Œä½¿ç”¨Dockerå®¹å™¨è¿è¡Œç¨‹åºã€‚

<!-- more -->

## é¢„å¤‡çŸ¥è¯†

åœ¨å¼€å§‹å¼€å‘ä¹‹å‰ï¼Œéœ€è¦å…ˆå®‰è£…Pythonå’ŒDockerã€‚

Pythonæ˜¯ä¸€ç§æµè¡Œçš„ç¼–ç¨‹è¯­è¨€ï¼Œå› æ­¤åœ¨è®¸å¤šæ“ä½œç³»ç»Ÿä¸Šéƒ½å¯ä»¥å¾ˆå®¹æ˜“åœ°å®‰è£…ã€‚å¯ä»¥ä½¿ç”¨[Miniconda](https://docs.conda.io/en/latest/miniconda.html)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„æ ‡å‡†å®‰è£…åŒ…è¿›è¡Œå®‰è£…ï¼Œä¸ªäººå–œæ¬¢Minicondaï¼Œä¸ä¼šåƒ[Anaconda](https://www.anaconda.com)é‚£ä¹ˆå¤§ï¼ŒåŒæ—¶åˆæä¾›äº†éå¸¸å¤šå¿…è¦çš„ä¾èµ–æ¨¡å—ã€‚

è€Œ[Docker](https://www.docker.com/)åˆ™æ˜¯ä¸€ç§å®¹å™¨åŒ–å¹³å°ï¼Œå¯å¸®åŠ©æˆ‘ä»¬è½»æ¾åœ°å°†åº”ç”¨ç¨‹åºå°è£…åœ¨å®¹å™¨ä¸­ï¼Œä¾¿äºéƒ¨ç½²å’Œç®¡ç†ã€‚ç›®å‰Windowsã€Linxã€macOSå¯¹Dockerçš„æ”¯æŒä¹Ÿéå¸¸çš„å®Œå–„äº†ã€‚

[FastAPI](https://fastapi.tiangolo.com/zh/) æ˜¯ä¸€ä¸ªç”¨äºæ„å»º API çš„ç°ä»£ã€å¿«é€Ÿï¼ˆé«˜æ€§èƒ½ï¼‰çš„ web æ¡†æ¶ï¼Œä½¿ç”¨ Python 3.6+ å¹¶åŸºäºæ ‡å‡†çš„ Python ç±»å‹æç¤ºã€‚

## åˆå§‹åŒ–é¡¹ç›®åŠè¿è¡Œç¯å¢ƒ

Pythonæ²¡æœ‰åƒJavaé‚£æ ·æå…¶æˆç†Ÿçš„ä¸€ç«™å¼çš„Mavené¡¹ç›®ç®¡ç†å·¥å…·ï¼Œä½†æ˜¯Pythonæœ‰å…¶è‡ªèº«çš„ç®€æ´ä¸è§„èŒƒã€‚åƒ[pyproject.toml](https://pip.pypa.io/en/stable/reference/build-system/pyproject-toml/)ï¼Œä»¥åŠæœ€è¿‘ç”¨Rustå†™çš„[rye](https://github.com/mitsuhiko/rye)ï¼Œéƒ½æ˜¯å¾ˆå‡ºè‰²çš„å·¥å…·ã€‚æœ¬æ–‡ä½¿ç”¨çš„ä¾‹å­ï¼Œå®Œå…¨ä½¿ç”¨æ‰‹åŠ¨ç®¡ç†å³å¯ğŸ˜„

åˆ›å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•my-projectï¼Œåˆ›å»ºæ–‡ä»¶`requirements.txt`ï¼Œ`main.py`ï¼Œ`Dockerfile`ï¼Œåé¢é€ä¸€å¡«å†™é‡Œé¢çš„å†…å®¹ã€‚

ä¸Šé¢æˆ‘ä»¬å®‰è£…äº†Minicondaï¼Œå»ºè®®ä½¿ç”¨condaæ¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒï¼Œè¿™æ ·å³ä¸ä¼šå½±å“å…¶ä»–é¡¹ç›®çš„è¿è¡Œç¯å¢ƒï¼Œè¿˜å¯ä»¥ä¿æŒæœ¬é¡¹ç›®è¿è¡Œç¯å¢ƒçš„æ•´æ´ã€‚

```Shell
conda create -n my-project python=3.9 pip
```

è¿™ä¸ªå‘½ä»¤åˆ›å»ºä¸€ä¸ªåä¸º`my-project`çš„è¿è¡Œç¯å¢ƒï¼ŒåŒæ—¶å®‰è£…3.9ç‰ˆæœ¬çš„Pythonï¼Œå’Œæœ€æ–°çš„`pip`å·¥å…·ã€‚

ç„¶åæ¿€æ´»è¿™ä¸ªè¿è¡Œç¯å¢ƒ

```Shell
conda activate my-project
```

## æ·»åŠ ä¾èµ–æ¨¡å—

æˆ‘ä»¬ä½¿ç”¨`requirements.txt`æ¥ç®¡ç†ç¨‹åºä¾èµ–çš„æ¨¡å—ï¼Œ`requirements.txt`æ–‡ä»¶å†…å®¹å¦‚ä¸‹

```Shell
-i https://mirrors.aliyun.com/pypi/simple/

fastapi
uvicorn[standard]
```

æœ¬æ–‡åªéœ€è¦ç”¨åˆ°è¿™ä¸¤ä¸ªæ¨¡å—ã€‚ç¬¬ä¸€è¡Œçš„`-i`æŒ‡å®špipä½¿ç”¨é˜¿é‡Œpypié•œåƒåœ°å€ï¼Œå¦‚æœåœ¨å›½å†…è¿™ä¼šå¤§å¤§åŠ å¿«ä¾èµ–å®‰è£…çš„é€Ÿåº¦ï¼Œå¯ä»¥æ¢æˆé˜¿é‡Œæˆ–è€…å…¶ä»–çš„é•œåƒæºã€‚

åœ¨æœ¬åœ°å¼€å‘ç”µè„‘ä¸Šå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å®‰è£…ä¾èµ–

```Shell
pip install -r requirements.txt
```

## ç¼–å†™ä»£ç 

### Pythonä»£ç 

FastAPIéå¸¸å®¹æ˜“ä½¿ç”¨ï¼Œä¹Ÿéå¸¸é€‚åˆå¿«é€Ÿå¼€å‘RESTful APIã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¿«é€Ÿå…¥é—¨çš„ç¤ºä¾‹ä»£ç ï¼š

```Python
from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return "Hello World"


@app.get("/items/{item_id}")
def read_item(item_id: int, q: str = None):
    return {"item_id": item_id, "q": q}

```

åœ¨è¿™ä¸ªç®€å•çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªFastAPIåº”ç”¨ç¨‹åºï¼Œå®ƒåŒ…æ‹¬ä¸¤ä¸ªè·¯ç”±ã€‚ç¬¬ä¸€ä¸ªè·¯ç”±å¤„ç†æ ¹è·¯å¾„å¹¶è¿”å›ä¸€ä¸ªç®€å•çš„â€œHello Worldâ€å­—ç¬¦ä¸²ã€‚ç¬¬äºŒä¸ªè·¯ç”±å¤„ç†ä¼ é€’ç»™å®ƒçš„è·¯å¾„å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›å‚æ•°çš„å€¼ã€‚ç¬¬äºŒä¸ªè·¯ç”±ä¼šä»¥jsonæ ¼å¼å“åº”å†…å®¹ç»™è°ƒç”¨è€…ï¼ˆFastAPIæ¡†æ¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å­—å…¸è½¬æ¢ä¸ºjsonæ•°æ®ï¼‰ã€‚

### æœ¬åœ°è¿è¡Œ

ç¼–å†™å®Œä¸Šé¢çš„ä»£ç ï¼Œä½¿ç”¨å‘½ä»¤`uvicorn main:app --host 0.0.0.0 --port 8080 --reload`å¯åŠ¨ç¨‹åºã€‚`--reload`é€‰é¡¹å¼€å¯äº†æ–‡ä»¶æ›´æ”¹åè‡ªåŠ¨é‡å¯åº”ç”¨ã€‚`main`æ˜¯æ¨¡å—çš„åç§°ï¼Œå†’å·åé¢çš„`app`æ˜¯å®ä¾‹åŒ–FastAPIå¯¹è±¡çš„å˜é‡åï¼Œå¯ä»¥æ›´æ¢æˆé€‚åˆåº”ç”¨åœºæ™¯çš„åç§°ã€‚

FastAPIè¿˜æœ‰ä¸€ä¸ªè´´å¿ƒçš„åŠŸèƒ½æ˜¯å†…ç½®äº†`swagger-ui`çš„æ”¯æŒï¼Œè®¿é—® http://localhost:8080/docs æ—¢å¯çœ‹åˆ°æ‰€æœ‰æ¥å£åˆ—è¡¨ï¼Œå¦‚ä¸‹å›¾

![Python FastAPI Docker](/img/Python/FastAPI%20Swagger-ui.png)

å†™ç”Ÿäº§ä»£ç çš„æ—¶å€™ï¼Œé™¤äº†å•å…ƒæµ‹è¯•ï¼Œè¿˜å¯ä»¥é€šè¿‡è¿™ä¸ªç•Œé¢è¿›è¡Œè°ƒè¯•ä¸å¼€å‘ï¼Œç›¸å½“çš„æ–¹ä¾¿ã€‚

### Dockeré…ç½®æ–‡ä»¶

å…ˆæ¥çœ‹çœ‹æ•´ä¸ªç›®å½•ç»“æ„

```Plain Text
|-- Dockerfile
|-- main.py
`-- requirements.txt
```

ä¸Šé¢å†™çš„Pythonä»£ç æœ¬æ–‡å¸Œæœ›æ”¾åœ¨ä¸€ä¸ªDockerå®¹å™¨æ¥è¿è¡Œï¼Œéœ€è¦ç¼–å†™ä¸€ä¸ªDockerfileé…ç½®æ–‡ä»¶ï¼Œè¿›è¡ŒDockeré•œåƒçš„ç¼–è¯‘ã€‚å°†FastAPIåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°Dockerå®¹å™¨ä¸­å¯ä»¥æ–¹ä¾¿åœ°å¤„ç†ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”æ˜“äºéƒ¨ç½²åˆ°å„ç§ç¯å¢ƒä¸­ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ç¼–å†™ä¸€ä¸ªç®€å•çš„Dockerfileï¼š

```Shell
FROM python:3.9

WORKDIR /app

RUN echo â€œAsia/Shanghaiâ€ > /etc/timezone && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

COPY requirements.txt /app/

RUN pip3 install -r requirements.txt --no-cache-dir

COPY main.py /app/main.py

EXPOSE 8080

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
```

1. æŒ‡å®šä½¿ç”¨python 3.9åŸºç¡€é•œåƒ
2. æŒ‡å®šå®¹å™¨å·¥ä½œç›®å½•ä¸º`/app`
3. è®¾ç½®å®¹å™¨çš„æ—¶åŒº
4. æ‹·è´`requirements.txt`åˆ°å®¹å™¨
5. ä½¿ç”¨`requirements.txt`å®‰è£…pythonä¾èµ–ï¼Œå¹¶ä¸”ä¸ç¼“å­˜ä¸‹è½½çš„ä¾èµ–åŒ…
6. æ‹·è´ä»£ç åˆ°å·¥ä½œç›®å½•`/app`
7. æš´éœ²ç«¯å£åˆ°å®¹å™¨å¤–
8. æŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶çš„æ‰§è¡Œå‘½ä»¤

## æ„å»ºå’Œè¿è¡ŒDockerå®¹å™¨

åœ¨ç»ˆç«¯çª—å£ä¸­ï¼Œå¯¼èˆªåˆ°Dockerfileæ‰€åœ¨çš„ç›®å½•ï¼Œå¹¶è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä»¥æ„å»ºDockeré•œåƒï¼š

```Shell
docker build -t my_fastapi_app .
```

æ­¤å‘½ä»¤å°†æ„å»ºåä¸ºmy_fastapi_appçš„Dockeré•œåƒã€‚æ¥ä¸‹æ¥ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œå®¹å™¨ï¼š

```Shell
docker run -d --name my_fastapi_container -p 8080:8080 my_fastapi_app
```

æ­¤å‘½ä»¤å°†å¯åŠ¨Dockerå®¹å™¨ï¼Œå¹¶å°†å®¹å™¨ç«¯å£8080æ˜ å°„åˆ°ä¸»æœºçš„ç«¯å£8080ã€‚è¿è¡Œåï¼Œå¯ä»¥ä½¿ç”¨`http://localhost:8080`è®¿é—®FastAPIåº”ç”¨ç¨‹åºã€‚

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬æˆåŠŸåœ°å°†FastAPIåº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°äº†Dockerå®¹å™¨ä¸­ã€‚è¿™ç§æ–¹å¼ä½¿å¾—æˆ‘ä»¬å¯ä»¥è½»æ¾åœ°ç®¡ç†åº”ç”¨ç¨‹åºçš„ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨ä¸åŒçš„ç¯å¢ƒä¸­å¿«é€Ÿéƒ¨ç½²åº”ç”¨ç¨‹åºã€‚





